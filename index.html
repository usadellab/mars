<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="MARS: Multi-omics Adapter for Repository Submissions">
  <meta name="keywords" content="MARS,">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    .center {
      position: relative;
      text-align: center;
    }

  

    .uploadarea {

      padding: 6px;
      border: 3px solid #4fb3d9;    
      border-style: outset;
      border-radius: 5px;
      -khtml-opacity: 0.5;
      -moz-opacity: 0.5;
      opacity: 0.5;
      height: 20vh;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234fb3d9' class='bi bi-cloud-upload' viewBox='0 0 16 16'><path fill-rule='evenodd' d='M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383'/><path fill-rule='evenodd' d='M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z'/></svg>");
      background-position: center;
      background-repeat: no-repeat;
      background-size: 64px 64px;

    }
    datalist {
      display: flex;
      justify-content: space-between;
      color: #4fb3d9;
      width: 100%;
    }
    .uploadarea:hover,
    .uploadarea.dragging,
    .uploadarea.uploading {
      filter: alpha(opacity=100);
      -khtml-opacity: 1;
      -moz-opacity: 1;
      opacity: 1;
    }

    .uploadarea input {
      margin: auto;
      width: 100%;
      height: 100%;

      border: none;
      cursor: pointer;
      opacity: 0;
    }

    .uploadarea input:focus {
      outline: none;
    }

    span.json {
      display: inline-block;
      
      margin: 4px;
      padding: 6px;
      border: 3px solid #4fb3d9;    
      border-style: outset;
      border-radius: 5px;
    }

    *[title]:hover:after {
      background-color:#8fe1d3;
      content: attr(name) '\A' attr(description);
      z-index: 1;
      position: absolute;

    }
    span.studies {
    background-color:#fff9e6;  

    }
    span.collapsed {
      border: 4px #c21f3a;  
      border-style:inset;
    }
    span.collapsed::before {
      content: "+"; 
      color:#c21f3a;
    }
    span.assays {
      background-color:#F8E8EB;  

    }

    .form-range{
      appearance: auto !important;
    }

  input[type="range"]::-webkit-slider-thumb {

  height: 15px;
  width: 15px;
  background-color: #fff;
  border-radius: 50%;
  border: 2px solid #4fb3d9;
      
  }

  input[type="range"]::-moz-range-thumb {
  height: 15px;
  width: 15px;
  background-color: #fff;
  border-radius: 50%;
  border: 1px solid #4fb3d9;


  }

  input[type="range"]::-moz-range-track {
  padding: 0 10px;
  background: repeating-linear-gradient(to right, 
    #ccc, 
    #ccc 10%, 
    #000 10%, 
    #000 11%, 
    #ccc 11%, 
    #ccc 20%);
}

  </style>

  <!--<script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>-->
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <script src="./js/bootstrap.bundle.min.js"></script>
  <link href="./css/custom2607.css" rel="stylesheet" />
  <link href="./css/bs5-intro-tour.css" rel="stylesheet" />
  <script src="./js/bs5-intro-tour.js" type="text/javascript" charset="utf-8"></script>
  <!--script src="js/example.js" type="text/javascript" charset="utf-8"></script-->
  <script src="./js/test_json_dataplant_no_investigation_small.js"></script>
  <script src="./js/test_json_datahub.js"></script>
  <script src="./js/dataplant_biosamples_returned_json.js"></script>
  <script src="./js/datahub_biosamples_returned_json.js"></script>
  <script src="./js/git.js"></script>
  <script src="./js/main.js"  type="text/javascript" ></script>
  <script src="./js/jsonata.min.js"></script>
  <script type="module">
  import http from './js/http.js'
  window.http = http;
  // window.fs = new LightningFS('fs')
  // window.pfs = window.fs.promises
  </script>
  

</head>

<body>
  <div class="col-12" style="background: rgb(45, 62, 80); height: 3.25rem; margin: 0 0 0 0px; padding: 0 0 0 0; ">
    <a class="" href="https://nfdi4plants.org/" style="">
      <img src="images/logo.png" alt="Logo" width="32" height="32"
        style="position: absolute; margin: 8px 12px 8px 12px; left: 0px; padding-top: 4px;" />
    </a>





    <div class="justify-content-center row d-flex align-items-center"
      style="margin: 0 0 0 0; ; padding: 0 0 0 0; height: 3.25rem;  ">


      <div class="btn-group d-md-none g-0 dropdown col-auto d-flex align-items-center" style="">
        <button type="button" class="btn rounded-0 border-0 g-0 btn-nav " data-bs-toggle="dropdown"
          aria-expanded="false" id="menu">
          Menu &nbsp;
          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converter_short" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlink_short" class="dropdown-item" href="https://github.com/elixir-europe/MARS">GitHub</a>
          </li>
          <li>
            <a id="us_short" class="dropdown-item" onclick=''>About Us</a>
          </li>

        </ul>
      </div>

      <div class="btn-group d-none g-0 d-md-block dropdown col-auto">

        <button type="button" onclick="location.href=location.href.split('#')[0]+'#a2j'" class="btn btn-nav" id="a2jNavBtn">
          ARC2ISA&nbsp;
          </button>
          <button type="button" onclick="location.href=location.href.split('#')[0]+'#isacheck'" class="btn  btn-nav" id="isacheckNavBtn">
            ISA Check &nbsp;
            </button>
          <button type="button" onclick="location.href=location.href.split('#')[0]+'#submit'" class="btn  btn-nav" id="submitNavBtn">
            MARS Submit &nbsp;
            </button>
        <button type="button" class="btn border-0 rounded-0 g-0 btn-nav" data-bs-toggle="dropdown" aria-expanded="false"
          id="conversion_tools">
          Menu &nbsp;

          <a
            style="display: inline-block; color: rgb(79, 179, 217); letter-spacing: 2px; font-size: 1em; transform: scaleX(2); transform-origin: 1 0;">
            ∨ </a>
        </button>
        <ul class="dropdown-menu">
          <li>
            <button id="converter_long" class="dropdown-item d-none" onclick=''>Converter</button>
          </li>
          <li>
            <a id="ghlink_long" class="dropdown-item" href="https://github.com/elixir-europe/MARS">GitHub</a>
          </li>
          <li>
            <a id="us_long" class="dropdown-item" href=''>About Us</a>
          </li>

        </ul>

      </div>




    </div>
  </div>
<div class="container">
  <div name="tab" class=" col-12 justify-content-center nav-link text-center" id="introTab">
    <a href="#a2j"><h1>Converts ARCs to ISA-JSONs </h1></a>
    <a href="#a2j"><h1>Checks, validate and auto complete of ISA-JSON </h1></a>
    <a href="#submit"><h1>ISA-JSON submission</h1></a>
  </div>

  <div name="tab" class="col-12 d-none" id="submissionTab">
  <h1 class="center">MARS: Multi-omics Adapter for Repository Submissions </h1>
  
    
    <form id="authForm" class="row justify-content-center">
      <div class="mb-3 col-2">
        <label for="username" class="form-label">ENA Username</label>
        <input type="text" class="form-control" id="username" aria-describedby="usernameHelp">
        <div id="usernameHelp" class="form-text d-none">The user name and password are used for token generation.</div>
      </div>
      <div class="mb-3 col-2">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password">
      </div>
      <div class="mb-3 form-check d-none">
        <input type="checkbox" class="form-check-input " id="passwordCheck">
        <label class="form-check-label" for="passwordCheck">Check me out</label>
      </div>
      <div class="mb-3 col-2 d-none">
        <label id="tokenHelp" class="form-text">Only collect token if you need.</label>
        <br>
      <button type="submit" id="formSubmit" class="btn btn-primary" aria-describedby="tokenHelp">Collect Token</button>
      
    </div>
    </form>
  

  <div class="center">

    DataPLANT test JSON -> BioSamples, click <a href="#" onclick="bstest(trim_dataplant(dataplant_json))">here</a> <br>
    DataHub test JSON   -> BioSamples, click <a href="#" onclick="bstest(datahub_json)">here</a> <br>
    DataPLANT test JSON -> ENA, click <a href="#" onclick="enatest(enaModify(dataplant_biosamples_returned_json))">here</a> <br>
    DataHub test JSON   -> ENA, click <a href="#" onclick="enatest(datahub_biosamples_returned_json)">here</a>
    <br>
    <input class="btn btn-primary d-inline d-none" type="file" id="input_json" name="json" multiple />
    

<br>
    <button class="btn btn-primary" style="display:inline" data-bs-toggle="modal" data-bs-target="#cModal"
      id="cModalButton"> Start Submissions </button>
    <div class="d-flex justify-content-center d-none" id="waiting">
      <div class="spinner-grow btn-primary" style="width: 3rem; height: 3rem;" role="status">
        <br>
        <span class="sr-only d-none">Loading...</span>
      </div>
    </div>
    <div style="margin:auto;" id="xml_output">
    </div>
  </div>

</div>

<div name="tab" class=" col-12 d-none" id="ARC2JSONTab">
  <div class="overflow-auto m-auto col-8 h-50"> 

    <table class="table table-striped hover">
      <thead>
        <tr>
          <th scope="col">Number</th>
          <th scope="col">User/Group</th>
          <th scope="col">Repo Name</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>

      <tbody>


      </tbody>
    </table>


  </div>
<form class="row g-3 align-items-center">
  <div class="row g-3 align-items-center">
    <div class="col-3 text-end">
      <label for="repoURL" class="col-form-label">ARC gitlab URL</label>
    </div>
    <div class="col-3">
      <input type="text" id="repoURL" value='https://git.nfdi4plants.org/ai.krueger/2024_GrowthCoupledHemeBiosensor.git' class="form-control" aria-describedby="repoURLLabel" required>
    </div>
    <div class="col-3">
      <span id="repoURLLabel" class="form-text">
        ARC Repository URL can be copied from the "Clone with HTTPS" section under code. It should start with "https://" and end with ".git"
      </span>
    </div>
  </div>


  <div class="row g-3 align-items-center d-none">
    <div class="col-3 text-end">
      <label for="gitusername" class="col-form-label">Username</label>
    </div>
    <div class="col-3">
      <input type="Gitusername" id="gitusername" class="form-control" aria-describedby="UsernameHelpInline">
    </div>
    <div class="col-3">
      <span id="UsernameHelpInline" class="form-text">
        The username or of DataHUB
      </span>
    </div>
  </div>
  
  <div class="row g-3 align-items-center">
    <div class="col-3 text-end">
      <label for="gitpassword" class="col-form-label">Access Token</label>
    </div>
    <div class="col-3">
      <input type="Gitpassword" placeholder="can be left empty" id="gitpassword" class="form-control" aria-describedby="passwordHelpInline">
    </div>
    <div class="col-3">
      <span id="passwordHelpInline" class="form-text">
        The personal access token can be left empty if the repository is publicly accessible.
      </span>
    </div>
  </div>
  <div class="col-3 m-auto align-items-center">
    <br>
    <button class="btn btn-primary" onclick="event.preventDefault(); cloneARC()" >Export ARC-JSON</button>
  </div>
</form>

  <div id="ARCInfo" class="col-6 m-auto">

  </div>
</div>
<div name="tab" class=" col-8 d-none align-items-center m-auto" id="isacheckTab">

  <div class=" area uploadarea my-3" id="importArea" ondragenter="this.className='area uploadarea dragging'"
  ondrop=";DragAndDrop(event)" style=" width:100%">


  <input type="file" id="import" multiple>
</div>
<div id="alertPlace" > </div>
<h4> ISA JSON Visualization: </h4>
<label for="jsonRange" class="form-label">Chose the level of details by slides (larger number = more details). The blocks can collapsed or explanded by clicks and the values will show when the blocks are hovered. 

</label>

<input type="range" class="form-range"  id="jsonRange"  min="2" max="2" onchange="setRange(this)" list="steplist">
<datalist id="steplist">

</datalist>
<div class="col-12 m-auto">
<span id="jsonVisualize" class="json m-auto">
   

</span>

</div>
</div>
</div>
<button type="button" class="btn btn-primary d-none" id="loadingModalBtn" data-bs-toggle="modal" data-bs-target="#loadingModal">
  Launch loading modal
</button>
<div class="modal" id="loadingModal"  backdrop="true" aria-labelledby="#loadingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="loadingModalLabel">Processing</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          

        </div>
        <span id="pbarLabel"> </span>
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" id="pbarModal" role="progressbar" aria-label="Animated striped example" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100" style="width: 1%">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        
      </div>
    </div>
  </div>
</div>
  <script type="text/javascript">
    var v_list, csv_content, cleanend_global, token , enaReturn = 0, biosamplesReturn= 0;
    var input_json = 0, input_xlsx;
    var log_backup = console.log;
    var fs = FS.fs;
    window.dir = "/arc"
        FS.mkdirSync(dir);
    var log_messages = [];
    var steps = [{
      title: "Converter and validators",
      content: '<p> Welcome! Our converter can convert an ISA-JSON file to multiple endpoint repositories such as ENA, Metabolites, EGA, EVA'
      //
    }
    ];

    var projectList;
    fetch('https://git.nfdi4plants.org/api/v4/projects')
      .then(data => {
      return data.json();
      })
      .then(post => {
      projectList = post;
      });

    var checklist= [
        {
            "key": "investigation",
            "jsonata": "$.$keys()",
            "error": "element.key + \" can not be found in\" element.jsonata",
            "fixfunction": null
        },
        {
            "key": "studies",
            "jsonata": "$.investigation.$keys()",
            "error": "element.key + \" can not be found in\" element.jsonata",
            "fixfunction": null
        }
        ]
    const loading = new bootstrap.Modal(document.getElementById('loadingModal'), {
        keyboard: true, show:false
      })
    function setRange(ele){
      loading.show()
      const order = Number(ele.value);
      const max = Number(ele.max);
      const id = order-1;
      //const preid = order-2;

        document.querySelectorAll('[data-order="'+id+'"]').forEach(e=> 
        {if (e.firstElementChild!=null){e.classList.add('collapsed');}} )
        for (let i = 1; i<order-1; i++)
        {
          document.querySelectorAll('[data-order="'+i+'"]').forEach(e=> 
          {if (e.firstElementChild!=null){e.classList.remove('collapsed');}} )
        }
          for (let i = 1; i<order; i++)
        {
          document.querySelectorAll('[data-order="'+i+'"]').forEach(e=> 
        {
          
          e.classList.remove('d-none');
        }
          
        );
        }
        for (let i = order; i<=max; i++)
        {
          document.querySelectorAll('[data-order="'+i+'"]').forEach(e=> 
        {
          if (e.firstElementChild!=null){
            e.classList.add('collapsed');
            
          }
          e.classList.add('d-none');
        }
          
        );
        }
        loading.hide();
    }
    
    const alertPlaceholder = document.getElementById('alertPlace')

      const alert = (message, type) => {
        const wrapper = document.createElement('div')
        wrapper.innerHTML = [
          `<div class="alert alert-${type} alert-dismissible" role="alert">`,
          `   <div>${message}</div>`,
          '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
          '</div>'
        ].join('')

        alertPlaceholder.append(wrapper)
      }
      function checkHas( key ,location, error) {
        const expression = "$assert('" + key + "' in "+location+", '"+error+"')" ; 
        return expression;
      }
    async function jCheck(json, expression) {
        var result = await jsonata(expression).evaluate(json);
        return result;
      }  
      async function checkall(checklist, isa){
        for (const [index, element] of Object.entries(checklist,)){
          try{ await jCheck( isa, checkHas(element.key, element.jsonata, element.key +" can not be found in " + element.jsonata));
           alert("passed", "success") }catch(e){alert(e.message, "danger")}

        }
      }
      // const alertTrigger = document.getElementById('liveAlertBtn')
      // if (alertTrigger) {
      //   alertTrigger.addEventListener('click', () => {
      //     alert('Nice, you triggered this alert message!', 'success')
      //   })
      // }
    //fetch('https://git.nfdi4plants.org/api/v4/projects')
      // .then(data => {
      // return data.json();
      // })
      // .then(post => {
      // console.log(post);
      // });
      window.id = 0;
      window.orderMax = 0;
      function traverse(json, parentNode, order) {
          if (typeof json !== 'object' || json === null) return;
          order +=1;
          window.orderMax = Math.max(order, window.orderMax)
          document.getElementById("jsonRange").setAttribute("max", window.orderMax);
          Object.entries(json).forEach(([key, value]) => {
            const keyAttribute = key.replace("@", "at");
              
              if (typeof(value)=='string'){
                try {
                  //parentNode.setAttribute(keyAttribute,value);
                  let childNode = document.createElement("span");
                  childNode.classList.add("json");
                  childNode.classList.add(key);
                  childNode.innerText = key;
                  childNode.setAttribute("title",value);
                  childNode.setAttribute("data-order",order);
                  parentNode.appendChild(childNode);
                } catch (error) {
                  alert(e);
                }
               
                if ((key=='@id')||(key=='name')){
                  //parentNode.innerText += key+ " "+ value+ " ";
                  
                  //parentNode.classList.add(value);
                }

              }else if (typeof(value)=='object'){
                let childNode = document.createElement("span");
                childNode.classList.add("json");
                childNode.classList.add(key);
                if ((Object.prototype.toString.call(json) === '[object Array]')){
                  childNode.innerText = Number(key)+1;
                }else{
                  childNode.innerText = key;
                }
                
                childNode.setAttribute("data-order",order);
                window.id += 1;
                try {
                  childNode.setAttribute("id","jsonId"+window.id);
                } catch (error) {
                  alert(e);
                }
                
                childNode.setAttribute("name",key);
                window.orderMax = Math.max(order, window.orderMax);
                const nextOrder = order +1;
                document.getElementById("jsonRange").setAttribute("max", window.orderMax);
                childNode.setAttribute("onclick","event.stopPropagation();this.classList.toggle('collapsed');  +1;this.querySelectorAll('span[data-order=\""+ nextOrder+"\"]').forEach(e=> e.classList.toggle('d-none'))");
                parentNode.appendChild(childNode);
                traverse(value, childNode, order);

              }
              ;
          });
      };

    function isaVis(json){
      checkall(checklist,json);
      window.orderMax= 0;
      window.path= 0;
      let ele1 = document.getElementById("jsonVisualize");
      ele1.innerHTML="";
      var order = 0;
      try {
        traverse(json, ele1,  order),
        setTimeout(e=>{loading.hide()},100 );
      } catch (error) {
        alert(error);
      }
      let stepListText = "";
      let jsonRange = document.getElementById("jsonRange");
      for (let i = 2; i <= Number(jsonRange.max); i++){
        stepListText += "<option value="+ i +" label="+i+" >"+i+"</option>"
      }
      document.getElementById("steplist").innerHTML=stepListText;
      jsonRange.value=3;
      jsonRange.onchange()
    }

    

    function updateLabel(phrase){
      document.getElementById("pbarLabel").innerHTML = phrase;
    }
    function updateProgressBar(progress){

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:'+progress+'%;')
      pbar.setAttribute("aria-valuenow", progress)
    }
    function updateIndeterminateProgressBar(progress){

      const pbar = document.getElementById("pbarModal");
      pbar.setAttribute("style", 'width:'+progress+'%;')
      pbar.setAttribute("aria-valuenow", progress)
      }
      
    

    async function cloneARC(){
      document.getElementById("loadingModalBtn").click();
      var url;
      const token = document.getElementById("gitpassword").value;
      if (!token){
        url = document.getElementById("repoURL").value;
        console.log(url)
      }else{
        [begin, end] = document.getElementById("repoURL").value.split("//")
        url = begin +"//oath2:"+token+"@"+end ;
        console.log(url)
      }
       
        const res = await git.clone({
        fs,
        http,
        dir,
        corsProxy: 'https://cors.isomorphic-git.org',
        url: url,
        ref: 'main',
        singleBranch: true,
        depth: 1,
        force: true,
        onProgress: event => {
          updateLabel(event.phase)
          if (event.total) {
            updateProgressBar(event.loaded / event.total)
          } else {
            updateIndeterminateProgressBar(event.loaded)
          }
        }
          })
        
          const ele = document.getElementById("ARCInfo");
          //ele.innerHTML= "Downloading ARC successful, files are "+ (FS.readdirSync(dir));
          const dec = new TextDecoder;
          var jsonText;
          await ARC2JSON("arc", "rna.json")
            jsonText=dec.decode(FS.readFileSync("rna.json"));
          
          
          ele.innerHTML += jsonText;
          dlText(jsonText, url.split("nfdi4plants.org").splice(-1)[0]);
          dataplant_json = JSON.parse(jsonText);
          document.getElementById("isacheckNavBtn").click()
          isaVis(dataplant_json);
           // Now it should not be empty...
       

    }
    
    function dlText(text, Name){
    var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(text);
    var dl = document.createElement('a');
    dl.setAttribute("href",     dataStr);
    dl.setAttribute("download", Name + ".json");
    document.body.appendChild(dl);
    dl.click();
    dl.remove();
  }


    var tour = new Tour(steps); // initialize the guided tour
    //tour.show();
    


    let output_div = document.getElementById("xml_output");
    function DragAndDrop(e) {
      e.preventDefault();
      
      let ele = document.getElementById("import");

      ele.files = e.dataTransfer.files;
      var reader = new FileReader(); // File reader to read the file 

      // This event listener will happen when the reader has read the file
      reader.addEventListener('load', function () {
        var result = JSON.parse(reader.result); // Parse the result into an object 
        isaVis(result);

        //console.log("result is : " + result);

      });

      reader.readAsText(ele.files[0]); // Read the uploaded file

    }
    function softRoute(){
          const urlRoute = window.location.href.split("#");
          const para = urlRoute.slice(-1)[0];
			    switch (para) {
                    case "submit":
                        document.querySelectorAll('div[name="tab"]').forEach((e)=> 
                        {
                            if (e.id == "submissionTab")
                              {e.classList.remove("d-none") }
                            else
                              {e.classList.add("d-none")}}
                          
                        )
                          break;
                    case "a2j":
                          document.querySelectorAll('div[name="tab"]').forEach((e)=> 
                          {
                            if (e.id == "ARC2JSONTab")
                              {e.classList.remove("d-none") }
                            else
                              {e.classList.add("d-none")}}
                          
                        )
                          break;
                    case "isacheck":
                          document.querySelectorAll('div[name="tab"]').forEach((e)=> 
                          {
                            if (e.id == "isacheckTab")
                              {e.classList.remove("d-none") }
                            else
                              {e.classList.add("d-none")}}
                          
                        )
                          break;
                          default:

                }
                
        }
    function checkInput(){
      try{
        const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if ( document.getElementById("import").files.length == 0 ){alert("There is no input file, the submission will use test file");
      bstest()}else{bstest();
        


      }}catch(e){
        alert("Error, submission not successful, error is" + e)
      }
      
    }

    console.log = function () {
      //log_messages.push.apply(log_messages, arguments);
      log_backup.apply(console, arguments);
      output_div.innerText = log_messages.join('\r\n');
    };
    const input1 = document.getElementById("import");
    input1.addEventListener("change", handleFiles1, false);

    function findValues(obj, key){
        return findValuesHelper(obj, key, []);
      }

    function findValuesHelper(obj, key, list) {
      if (!obj) return list;
      if (obj instanceof Array) {
        for (var i in obj) {
            list = list.concat(findValuesHelper(obj[i], key, []));
        }
        return list;
      }
      if (obj[key]) list.push(obj[key]);

      if ((typeof obj == "object") && (obj !== null) ){
        var children = Object.keys(obj);
        if (children.length > 0){
          for (i = 0; i < children.length; i++ ){
              
              if ((children[i] == "value")&& ((typeof obj["value"] =="string" )|| (typeof obj["value"] =="number"))) {
                if ((children[i-1] == "category")||(children[i-1] == "category") ){
                  const oldValue = obj["value"];
                  obj["value"] = { }
                  obj["value"].annotationValue = oldValue;
                  obj["value"].termAccession= "";
                  obj["value"].termSource= "";
                  }

                }


                list = list.concat(findValuesHelper(obj[children[i]], key, []));
              }
              
          }
        }
      
      return list;
    }

  //   
  


    function handleFiles1() {

      if (this.files.length > 0) {
        loading.show();
        var reader = new FileReader(); // File reader to read the file 

        // This event listener will happen when the reader has read the file
        reader.addEventListener('load', function () {
          var result   = JSON.parse(reader.result); // Parse the result into an object 
          //console.log("reader.result is : "+reader.result);
          //input_json = {"investigation": result};
          //testJSON = {"investigation": result};
          isaVis(result);
          //testJSON= result;
          // testJSON.investigation.studies.forEach((ele)=>{Object.values(ele.materials).forEach((ele2)=>{console.log(findValues(ele2, "value"))})});
          // testJSON.investigation.studies.forEach((ele)=>{Object.values(ele.processSequence).forEach((ele2)=>{console.log(findValues(ele2, "value"))})});
          // testJSON.investigation.studies.forEach((ele)=>{Object.values(ele.assays).forEach((ele2)=>{console.log(findValues(ele2, "value"))})});
          //console.log("result is : " + result);


        });

        reader.readAsText(this.files[0]); // Read the uploaded file

      } else {

        window.alert("no file is selected to import");

      };
    }


    function bstest(testJSON){
      loading.show();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // Construct the request body
      var requestBody = {
        authRealms: ['ENA'],
        password: password,
        username: username
      };
      
      // Send the POST request using Fetch API
      fetch('https://wwwdev.ebi.ac.uk/ena/submit/webin/auth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      })
      .then((response) => response.text())
      .then(text => {
        console.log('Response:', text);
        token = text;
        document.getElementById("tokenText").innerText=token;
        document.getElementById("tokenStatus").innerText="Returned";
        bsSubmit(testJSON);
        //document.getElementById("status_modal_button").click();
        // Handle the response here
      })
      .catch(error => {
        console.error('Error:', error);
        // Handle errors here
      });

    }

  //   function tokenButton(){

  //     document.getElementById('authForm').addEventListener('submit', function(event) {
  //     event.preventDefault(); // Prevent the default form submission
      
  //     // Get the username and password from the input fields

  //   });
  // }

  
  window.addEventListener("load", (event) => {
    softRoute();
});
   
    // function bstest(testJSON){
    //   const username = document.getElementById('username').value;
    //   const password = document.getElementById('password').value;
      
    //   getToken(testJSON);
      
      

    // }

    function enatest(testJSON){
      loading.show();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      enaSubmit(username, password, testJSON);

    }

    function enaSubmit(name, password, json){
        json = 
        fetch('https://ena.cplantbox.com/isaena/submit?webinUserName='+name+'&webinPassword='+password, {
          method: 'POST',
          //mode: 'cors',
          headers: {
            
            'Content-Type': 'application/json',
            'accept': '*/*'
          },
          body: biosamplesReturn || JSON.stringify(json)
        })
        .then((response) => response.text())
        .then(data => {
          console.log('Success: ', data);
          enaReturn = data;
          document.getElementById("enaStatus").innerText="Returned";
          document.getElementById("enaText").innerText=enaReturn;
              document.getElementById("status_modal_button").click();

        })
        .catch(error => {
          alert("ENA submission failed, error is " + error+". Please check your username and password");
          console.error('Error:', error);

        });

};

function trim_dataplant(input){

  const invinput = {"investigation": input} ;
  const jsText = JSON.stringify(invinput);
  const replacedText1 = jsText.replaceAll(/(\"value\"\:)(\"\w+\")/gm , '$1{ "@id": "", "annotationValue" :$2, "termAccession":"","termSource":"" }') 
  const replacedText2 = replacedText1.replaceAll(/(\"value\"\:)(\d+(\d+|[.])\d+)[,]/gm , '$1{ "@id": "", "annotationValue" :"$2", "termAccession":"","termSource":"" },')

  const replacedText3 = replacedText2.replaceAll(/(\"value\"\:)(\d+)/gm , '$1{ "@id": "", "annotationValue" :"$2", "termAccession":"","termSource":"" }')
  
  const replacedText4 = replacedText3.replaceAll(/(\#MaterialAttribute\/)(OBI\:0100026)/gm , '$1organism/$2')
  let finalJSON = JSON.parse(replacedText4);
  finalJSON["investigation"]["studies"] = [finalJSON["investigation"]["studies"][0]]
  return finalJSON;
}


function bsSubmit( json){
      
      const fulltoken = "https://biosamples.cplantbox.com/isabiosamples/submit?webinjwt="+ token;
      fetch( fulltoken , {
        method: 'POST',
        //mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
          'accept': '*/*'
        },
        body: JSON.stringify(json)
      })
      .then((response) => response.text())
      .then(data => {
        console.log('Success: ', data);
        biosamplesReturn = data;
        document.getElementById("biosamplesStatus").innerText="Returned";
        document.getElementById("biosamplesText").innerText=biosamplesReturn;
            document.getElementById("status_modal_button").click();

      })
      .catch(error => {
        alert("BioSamples submission failed, error is " + error+". Please check your jwt token");
        console.error('Error:', error);
      });

    };

    function enaModify(preJSON, otherMaterial){
      Boolean(preJSON.investigation.studies[0].name) ? {} : preJSON.investigation.studies[0]["name"] = "Multi-omics study";
      Boolean(preJSON.investigation.studies[0].title) ? {} : preJSON.investigation.studies[0]["title"] = "Multi-omics study";
        preJSON.investigation.studies[0].protocols.push(addStudyProcessSequence("abc"));
        preJSON.investigation.studies[0].assays.splice(-2);
        preJSON.investigation.studies[0].assays[0].processSequence.push(addAssayProcessSequence("abc", "aasa", otherMaterial));
        preJSON.investigation.studies[0].assays[0].materials["otherMaterials"] = addOtherMatial(otherMaterial, "aaa")["otherMaterials"];
        
        return preJSON;

        }

    function addOtherMatial(otherMaterialId, derivesFromId){
      var otherMaterial =  {"otherMaterials" : [
            {
                "name" : "library 1",
                "@id" : "#"+otherMaterialId,
                //"id" : "Multi-omics study",
                "type" : "Library Name",
            "derivesFrom" : [ 
                {
                "@id" : "#"+derivesFromId
              } 
            ]
              }
          ]} 
          return otherMaterial;
    }

    function addStudyProcessSequence(protocolID) {
      var StudyProcessSequence=       {
          "name" : "library construction",
          "protocolType" : {
            "annotationValue" : "library construction",
            "termAccession" : "",
            "termSource" : ""
          },
          "description" : "",
          "uri" : "",
          "version" : "",
          "parameters" : [ {
            "parameterName" : {
              "annotationValue" : "library_construction_protocol",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/349"
          }, {
            "parameterName" : {
              "annotationValue" : "design_description",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/351"
          }, {
            "parameterName" : {
              "annotationValue" : "library source",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/352"
          }, {
            "parameterName" : {
              "annotationValue" : "library strategy",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/353"
          }, {
            "parameterName" : {
              "annotationValue" : "library selection",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/354"
          }, {
            "parameterName" : {
              "annotationValue" : "library layout",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/355"
          }, {
            "parameterName" : {
              "annotationValue" : "insert size",
              "termAccession" : "",
              "termSource" : ""
            },
            "@id" : "#parameter/356"
          } ],
          "components" : [ {
            "componentName" : "",
            "componentType" : {
              "annotationValue" : "",
              "termSource" : "",
              "termAccession" : ""
            }
          } ],
          "@id" : "#"+protocolID
        };
        return StudyProcessSequence;
      }
      function addAssayProcessSequence(protocolID, inputID, outputID) {
      var assayProcessSequence = {
            "name" : "",
            "executesProtocol" : {
              "@id" : "#"+protocolID
            },
            "parameterValues" : [ 
              {
              "category" : {
                "@id" : "#parameter/349"
              },
              "value" : {
                "annotationValue" : "lib prep",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            }, {
              "category" : {
                "@id" : "#parameter/351"
              },
              "value" : {
                "annotationValue" : "Test",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            }, {
              "category" : {
                "@id" : "#parameter/352"
              },
              "value" : {
                "annotationValue" : "OTHER",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            }, {
              "category" : {
                "@id" : "#parameter/353"
              },
              "value" : {
                "annotationValue" : "RNA-Seq",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            }, {
              "category" : {
                "@id" : "#parameter/354"
              },
              "value" : {
                "annotationValue" : "other",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            }, {
              "category" : {
                "@id" : "#parameter/355"
              },
              "value" : {
                "annotationValue" : "SINGLE",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            }, {
              "category" : {
                "@id" : "#parameter/356"
              },
              "value" : {
                "annotationValue" : "100",
                "termSource" : "",
                "termAccession" : ""
              },
              "unit" : {
                "termSource" : "",
                "termAccession" : "",
                "comments" : [ ]
              }
            } ],
            "inputs" : [ {
            "@id" : "#"+inputID
          } ],
          "outputs" : [ {
            "@id" : "#"+outputID
          } ],
            "performer" : "",
            "date" : "",
            "@id" : "#additionalProcess",
          }
          return assayProcessSequence;
    }



  </script>
  <script type="module">
    //import { EnaBroker } from "./js/broker/ena/ena.broker.js";
    //import { MetabolightsBroker } from "./js/broker/metabolights/metabolights.broker.js";
    //import { BiosamplesService } from "./js/broker/biosamples/biosamples.service.js";
    //import { BrokerType } from "./js/broker/broker.type.js";
    //import { BrokerStatus } from "./js/broker/status.type.js";

    function submit(repository, isaJson) {
      switch (repository) {
        case ("biosamples"):
          const biosamplesService = new BiosamplesService(isaJson);
          biosamplesService.processService.addItem(document.getElementById("biosamplesloading"));
          return biosamplesService.submit(isaJson);
        case ("ENA"):
          const enaBroker = new EnaBroker(isaJson);
          enaBroker.processService.addItem(document.getElementById("ENAloading"));
          return enaBroker.submit(isaJson);
        case ("metabolights"):
          const matabolightsBroker = new MetabolightsBroker(isaJson);
          matabolightsBroker.processService.addItem(document.getElementById("metabolightsloading"));
          return matabolightsBroker.submit(isaJson);
      }
    }


    addEventListener("hashchange", (event) => {

      if (true){
        softRoute();
      }

      });

      
    function submitAll(endRepo) {
      let repositories = [];
      for (const [index, element] of endRepo.entries()) {
        repositories.push(element.id);
        document.getElementById(`${element.id}loading`)?.addEventListener("broker", (e) => {
          if (e.detail.status === BrokerStatus.Running) {
            e.target.className = "spinner-border text-primary";
          }
          else {
            e.target.className = "spinner-border text-primary d-none";
          }
        });
      }
      // If both Biosamples and ENA are selected, submit to Biosamples first, then submit the result to ENA
      if (repositories.includes("biosamples") && repositories.includes("ENA")) {
        repositories = repositories.filter(repo => !["biosamples", "ENA"].includes(repo));
        submit("biosamples", input_json).then((updatedIsaJson) => submit("ENA", updatedIsaJson));
      }
      // Submit to the selected repositories
      for (const repository of repositories) {
        submit(repository, input_json);
      }
    }
    
    

  </script>
  <!-- Button trigger modal -->
  <button type="button" class="d-none btn btn-primary">
    Launch convert modal
  </button>
  <!--Modal for submission-->
  <div class="modal fade" id="cModal" tabindex="-1" data-bs-backdrop="static" aria-labelledby="cModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-xl-down">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="cModalLabel">Upload to Endpoint Repositories</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col">
                <div class="row">
                  <div class="col">
                    <div class="form-check" id="submitRepos">
                      <input class="form-check-input" type="checkbox" value="" id="biosamples" name="repo" checked>
                      <label class="form-check-label" for="biosamples">
                        BioSamples

                      </label>

                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="biosamplesloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="ENA" name="repo">
                      <label class="form-check-label" for="ENA">
                        ENA
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="ENAloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="metabolights" name="repo">
                      <label class="form-check-label" for="metabolights">
                        Metabolites
                      </label>
                    </div>
                  </div>
                  <div class="col">
                    <div class="spinner-border text-primary d-none" id="metabolightsloading" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>


            </div>
          </div>
          <table id="validate_table" class="table table-bordered table-hover">

          </table>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download updated JSON</button>
          <button type="button" class="btn btn-primary"
            onclick="var checkedBoxes = document.querySelectorAll('input[name=repo]:checked'); submitAll(checkedBoxes)">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary d-none" data-bs-toggle="modal" data-bs-target="#status_modal"
    id="status_modal_button">
    Show Status
  </button>

  <!-- Modal -->
  <div class="modal modal-xl fade" id="status_modal" tabindex="-1" data-bs-backdrop="static"
    aria-labelledby="status_modal_label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="status_modal_label">Status Table</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <span id="init_word"> </span>
          <br>
          <span ></span> Submission Status<br>
          
          <table id="infoTable" class="table table-bordered table-hover" style="table-layout:auto; width: 100%;">
            <thead>
              <tr>
                <th scope="col">Repositories</th>
                <th scope="col">Status</th>
                <th scope="col">Returned</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">Token</th>
                <td id="tokenStatus">not asked</td>
                <td > <div style="overflow-wrap: break-all;
                  word-break: break-all;" id="tokenText"></div></td>
                <td >...</td>
              </tr>
              <tr>
                <th scope="row">ENA</th>
                <td id="enaStatus">not asked</td>
                <td ><div style="overflow-wrap: break-all;
                  word-break: break-all;" id="enaText"></div></td>
                <td >...</td>
              </tr>
              <tr>
                <th scope="row">BioSamples</th>
                <td id="biosamplesStatus">not asked</td>
                <td id="biosamplesText">...</td>
                <td >...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">download files</button>
          
        </div>
      </div>
    </div>
    <!-- Modal -->
    
  </div>

  <!-- Button trigger modal -->


</body>
<script>

</script>
</html>
